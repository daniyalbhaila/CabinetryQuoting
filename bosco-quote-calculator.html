<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bosco Cabinetry | Quote Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --bg-card: #1e1e1e;
            --accent: #c9a227;
            --accent-dim: #8a7019;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --text-muted: #666;
            --border: #333;
            --success: #4ade80;
            --error: #f87171;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.5; }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 0.75rem; }
        .logo-icon { width: 40px; height: 40px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--bg-primary); font-size: 1.25rem; }
        .logo-text { font-weight: 700; font-size: 1.25rem; letter-spacing: -0.02em; }
        .logo-text span { color: var(--accent); }
        .quote-total-header { font-family: 'Space Mono', monospace; font-size: 1.5rem; color: var(--accent); }
        .main { max-width: 1400px; margin: 0 auto; padding: 2rem; display: grid; grid-template-columns: 320px 1fr; gap: 2rem; }
        .sidebar { position: sticky; top: 80px; height: fit-content; display: flex; flex-direction: column; gap: 1rem; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: background 0.2s; }
        .card-header:hover { background: var(--bg-tertiary); }
        .card-header-left { display: flex; align-items: center; gap: 0.5rem; }
        .card-header h2 { font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
        .card-header .chevron { transition: transform 0.2s; color: var(--text-muted); }
        .card-header.collapsed .chevron { transform: rotate(-90deg); }
        .card-body { padding: 1.25rem; }
        .card-body.collapsed { display: none; }
        .form-group { margin-bottom: 1rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label { display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.03em; }
        .form-input, .form-select { width: 100%; padding: 0.625rem 0.875rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 0.9375rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.15); }
        .form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23a0a0a0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; padding-right: 2.5rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .divider { height: 1px; background: var(--border); margin: 1rem 0; }
        .dimension-display { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; font-family: 'Space Mono', monospace; }
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: 8px; font-family: inherit; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background: var(--accent); color: var(--bg-primary); }
        .btn-primary:hover { background: #d4ad2d; transform: translateY(-1px); }
        .btn-danger { background: transparent; color: var(--error); padding: 0.5rem; }
        .btn-danger:hover { background: rgba(248, 113, 113, 0.1); }
        .content { display: flex; flex-direction: column; gap: 1rem; }
        .items-header { display: flex; justify-content: space-between; align-items: center; }
        .items-header h1 { font-size: 1.5rem; font-weight: 600; }
        .line-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: border-color 0.2s; animation: fadeIn 0.3s ease-out; }
        .line-item:hover { border-color: var(--accent-dim); }
        .line-item-header { padding: 1rem 1.25rem; background: var(--bg-tertiary); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .line-item-header:hover { background: #2a2a2a; }
        .line-item-left { display: flex; align-items: center; gap: 0.75rem; }
        .line-item-number { width: 28px; height: 28px; background: var(--accent); color: var(--bg-primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; flex-shrink: 0; }
        .line-item-name-input { background: transparent; border: none; color: var(--text-primary); font-size: 1.125rem; font-weight: 600; font-family: inherit; width: 200px; }
        .line-item-name-input:focus { outline: none; }
        .line-item-name-input::placeholder { color: var(--text-muted); }
        .line-item-summary { display: flex; align-items: center; gap: 1.5rem; font-size: 0.875rem; color: var(--text-secondary); }
        .line-item-right { display: flex; align-items: center; gap: 1rem; }
        .line-item-price { font-family: 'Space Mono', monospace; font-size: 1.25rem; color: var(--accent); }
        .line-item-chevron { color: var(--text-muted); transition: transform 0.2s; }
        .line-item.collapsed .line-item-chevron { transform: rotate(-90deg); }
        .line-item-body { padding: 1.25rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; border-top: 1px solid var(--border); }
        .line-item.collapsed .line-item-body, .line-item.collapsed .line-item-footer { display: none; }
        .line-item-section { display: flex; flex-direction: column; gap: 0.75rem; }
        .line-item-section-title { font-size: 0.6875rem; font-weight: 600; color: var(--accent); text-transform: uppercase; letter-spacing: 0.08em; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
        .input-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .input-group label { font-size: 0.6875rem; color: var(--text-muted); }
        .input-group input, .input-group select { padding: 0.5rem 0.625rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: inherit; font-size: 0.875rem; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--accent); }
        .input-group input[type="number"] { font-family: 'Space Mono', monospace; }
        .input-group select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a0a0a0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; padding-right: 1.75rem; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .override-section { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border); }
        .override-toggle { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--text-muted); cursor: pointer; padding: 0.375rem 0; transition: color 0.2s; }
        .override-toggle:hover, .override-toggle.active { color: var(--accent); }
        .override-content { display: none; margin-top: 0.75rem; }
        .override-content.show { display: block; }
        .line-item-footer { padding: 0.75rem 1.25rem; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .cost-breakdown { display: flex; gap: 1.5rem; font-size: 0.8125rem; }
        .cost-item { display: flex; gap: 0.375rem; }
        .cost-item-label { color: var(--text-muted); }
        .cost-item-value { font-family: 'Space Mono', monospace; color: var(--text-secondary); }
        .quote-summary { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%); border: 2px solid var(--accent); border-radius: 12px; padding: 1.5rem; margin-top: 1rem; }
        .quote-summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .quote-summary-header h2 { font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; padding: 1rem 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .summary-item { text-align: center; }
        .summary-item-label { font-size: 0.6875rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
        .summary-item-value { font-family: 'Space Mono', monospace; font-size: 1.125rem; color: var(--text-primary); }
        .quote-total { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; }
        .quote-total-label { font-size: 1.25rem; font-weight: 600; }
        .quote-total-value { font-family: 'Space Mono', monospace; font-size: 2rem; font-weight: 700; color: var(--accent); }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .empty-state h3 { font-size: 1.125rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .empty-state p { font-size: 0.875rem; margin-bottom: 1.5rem; }
        @media (max-width: 1200px) { .main { grid-template-columns: 1fr; } .sidebar { position: static; } }
        @media (max-width: 768px) { .main { padding: 1rem; } .line-item-body { grid-template-columns: 1fr; } .summary-grid { grid-template-columns: repeat(2, 1fr); } .line-item-summary { display: none; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">B</div>
                <div class="logo-text">Bosco <span>Cabinetry</span></div>
            </div>
            <div class="quote-total-header" id="headerTotal">$0.00</div>
        </div>
    </header>
    <main class="main">
        <aside class="sidebar">
            <div class="card">
                <div class="card-header" onclick="toggleCard('projectSettings')">
                    <div class="card-header-left">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/></svg>
                        <h2>Project Settings</h2>
                    </div>
                    <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="card-body" id="projectSettings">
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" id="projectType" onchange="onProjectTypeChange()">
                            <option value="full">Full House</option>
                            <option value="single">Single Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Carcass Supplier (Default)</label>
                        <select class="form-select" id="carcassSupplier" onchange="recalculateAll()">
                            <option value="holike">Holike ($65/sqm)</option>
                            <option value="allure">Allure ($200/sqm)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Default Ceiling Height</label>
                        <select class="form-select" id="defaultCeiling" onchange="onCeilingChange()">
                            <option value="8">8 ft (2450mm / 96")</option>
                            <option value="9">9 ft (2750mm / 108")</option>
                            <option value="10">10 ft (3050mm / 120")</option>
                            <option value="11">11 ft (3350mm / 132")</option>
                            <option value="12">12 ft (3660mm / 144")</option>
                            <option value="13">13 ft (3960mm / 156")</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header collapsed" onclick="toggleCard('ratesSettings')">
                    <div class="card-header-left">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        <h2>Rates</h2>
                    </div>
                    <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="card-body collapsed" id="ratesSettings">
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Shipping ($/LF)</label><input type="number" class="form-input" id="shippingRate" value="60" onchange="recalculateAll()"></div>
                        <div class="form-group"><label class="form-label">Install ($/LF)</label><input type="number" class="form-input" id="installRate" value="100" onchange="recalculateAll()"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Drawer ($)</label><input type="number" class="form-input" id="drawerRate" value="200" onchange="recalculateAll()"></div>
                        <div class="form-group"><label class="form-label">Accessory ($)</label><input type="number" class="form-input" id="accessoryRate" value="300" onchange="recalculateAll()"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Markup (%)</label><input type="number" class="form-input" id="markupRate" value="80" onchange="recalculateAll()"></div>
                        <div class="form-group"><label class="form-label">Discount (%)</label><input type="number" class="form-input" id="discountRate" value="50" onchange="recalculateAll()"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">USD to CAD Exchange Rate</label>
                        <input type="number" class="form-input" id="exchangeRate" value="1.42" step="0.01" onchange="recalculateAll()">
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header collapsed" onclick="toggleCard('dimensionSettings')">
                    <div class="card-header-left">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 3H3v18h18V3z"/><path d="M9 3v18M3 9h18"/></svg>
                        <h2>Default Dimensions</h2>
                    </div>
                    <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="card-body collapsed" id="dimensionSettings">
                    <div class="form-group"><label class="form-label">Upper Cabinet Height</label><input type="number" class="form-input" id="defaultUpperHt" value="760" onchange="recalculateAll()"><div class="dimension-display" id="upperHtDisplay">760mm / 30"</div></div>
                    <div class="form-group"><label class="form-label">Base Cabinet Height</label><input type="number" class="form-input" id="defaultBaseHt" value="920" onchange="recalculateAll()"><div class="dimension-display" id="baseHtDisplay">920mm / 36"</div></div>
                    <div class="divider"></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Upper Depth</label><input type="number" class="form-input" id="defaultUpperDp" value="300" onchange="recalculateAll()"><div class="dimension-display">300mm / 12"</div></div>
                        <div class="form-group"><label class="form-label">Base Depth</label><input type="number" class="form-input" id="defaultBaseDp" value="600" onchange="recalculateAll()"><div class="dimension-display">600mm / 24"</div></div>
                    </div>
                    <div class="form-group"><label class="form-label">Pantry Depth</label><input type="number" class="form-input" id="defaultPantryDp" value="600" onchange="recalculateAll()"><div class="dimension-display">600mm / 24"</div></div>
                </div>
            </div>
        </aside>
        <div class="content">
            <div class="items-header">
                <h1>Line Items</h1>
                <button class="btn btn-primary" onclick="addLineItem()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add Item
                </button>
            </div>
            <div id="lineItemsContainer"></div>
            <div class="quote-summary" id="quoteSummary" style="display: none;">
                <div class="quote-summary-header"><h2>Quote Summary</h2><span id="totalLF">0 LF Total</span></div>
                <div class="summary-grid">
                    <div class="summary-item"><div class="summary-item-label">Cabinetry</div><div class="summary-item-value" id="totalCabinetry">$0</div></div>
                    <div class="summary-item"><div class="summary-item-label">Shipping</div><div class="summary-item-value" id="totalShipping">$0</div></div>
                    <div class="summary-item"><div class="summary-item-label">Install</div><div class="summary-item-value" id="totalInstall">$0</div></div>
                    <div class="summary-item"><div class="summary-item-label">Subtotal</div><div class="summary-item-value" id="totalSubtotal">$0</div></div>
                </div>
                <div class="quote-total"><div class="quote-total-label">Grand Total</div><div class="quote-total-value" id="grandTotal">$0.00</div></div>
            </div>
        </div>
    </main>
    <script>
        const FINISH_RATES = { 'PVC': { unshaped: 100, shaped: 200 }, 'Melamine': { unshaped: 70, shaped: 70 }, 'Skin': { unshaped: 150, shaped: 150 }, 'Paint/Lacquer': { unshaped: 170, shaped: 200 }, 'Powder': { unshaped: 100, shaped: 200 }, 'Veneer': { unshaped: 440, shaped: 440 }, 'PET': { unshaped: 110, shaped: 110 } };
        const CEILING_TO_MM = { '8': 2450, '9': 2750, '10': 3050, '11': 3350, '12': 3660, '13': 3960 };
        const CEILING_TO_UPPER_HT = { '8': 760, '9': 920, '10': 1070, '11': 1220, '12': 1320, '13': 1473 };
        let lineItems = [];
        let nextId = 1;

        function mmToInches(mm) { return Math.round(mm / 25.4); }
        function formatDimension(mm) { return mm + 'mm / ' + mmToInches(mm) + '"'; }
        function formatCurrency(amount) { return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' CAD'; }

        function toggleCard(cardId) {
            const cardBody = document.getElementById(cardId);
            const cardHeader = cardBody.previousElementSibling;
            cardBody.classList.toggle('collapsed');
            cardHeader.classList.toggle('collapsed');
        }

        function toggleLineItem(id, event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'BUTTON' || event.target.closest('button')) return;
            const item = lineItems.find(i => i.id === id);
            if (item) { item.collapsed = !item.collapsed; renderLineItems(); }
        }

        function toggleOverride(id, event) {
            event.stopPropagation();
            const item = lineItems.find(i => i.id === id);
            if (item) { item.showOverride = !item.showOverride; renderLineItems(); }
        }

        function getProjectSettings() {
            const projectType = document.getElementById('projectType').value;
            const isFullHouse = projectType === 'full';
            const defaultCeiling = document.getElementById('defaultCeiling').value;
            return {
                projectType, isFullHouse,
                carcassSupplier: document.getElementById('carcassSupplier').value,
                carcassRate: document.getElementById('carcassSupplier').value === 'holike' ? 65 : 200,
                defaultCeiling,
                defaultCeilingMm: CEILING_TO_MM[defaultCeiling] || 2450,
                shippingRate: parseFloat(document.getElementById('shippingRate').value) || 60,
                installRate: parseFloat(document.getElementById('installRate').value) || (isFullHouse ? 100 : 120),
                drawerRate: parseFloat(document.getElementById('drawerRate').value) || 200,
                accessoryRate: parseFloat(document.getElementById('accessoryRate').value) || 300,
                exchangeRate: parseFloat(document.getElementById('exchangeRate').value) || 1.42,
                markupRate: (parseFloat(document.getElementById('markupRate').value) || 80) / 100,
                discountRate: (parseFloat(document.getElementById('discountRate').value) || 50) / 100,
                defaultUpperHt: parseFloat(document.getElementById('defaultUpperHt').value) || CEILING_TO_UPPER_HT[defaultCeiling] || 760,
                defaultBaseHt: parseFloat(document.getElementById('defaultBaseHt').value) || 920,
                defaultUpperDp: parseFloat(document.getElementById('defaultUpperDp').value) || 300,
                defaultBaseDp: parseFloat(document.getElementById('defaultBaseDp').value) || 600,
                defaultPantryDp: parseFloat(document.getElementById('defaultPantryDp').value) || 600
            };
        }

        function getEffectiveDimensions(item) {
            const settings = getProjectSettings();
            const ceilingFt = item.ceilingFt || settings.defaultCeiling;
            const ceilingMm = CEILING_TO_MM[ceilingFt] || settings.defaultCeilingMm;
            const baseUpperHt = CEILING_TO_UPPER_HT[ceilingFt] || settings.defaultUpperHt;
            let upperHt = item.showOverride && item.upperHt ? item.upperHt : baseUpperHt;
            let baseHt = item.showOverride && item.baseHt ? item.baseHt : settings.defaultBaseHt;
            let upperDp = item.showOverride && item.upperDp ? item.upperDp : settings.defaultUpperDp;
            let baseDp = item.showOverride && item.baseDp ? item.baseDp : settings.defaultBaseDp;
            let pantryDp = item.showOverride && item.pantryDp ? item.pantryDp : settings.defaultPantryDp;
            const carcassSupplier = item.carcassSupplier || settings.carcassSupplier;
            const carcassRate = carcassSupplier === 'holike' ? 65 : 200;
            return { ceilingFt, ceilingMm, upperHt, baseHt, upperDp, baseDp, pantryDp, carcassSupplier, carcassRate, baseUpperHt };
        }

        function calculateLineItem(item) {
            const settings = getProjectSettings();
            const dims = getEffectiveDimensions(item);
            const upperM = (item.upperLF || 0) * 0.3048;
            const baseM = (item.baseLF || 0) * 0.3048;
            const pantryM = (item.pantryLF || 0) * 0.3048;
            const totalLF = (item.upperLF || 0) + (item.baseLF || 0) + (item.pantryLF || 0);
            const doorArea = (upperM * (dims.upperHt / 1000)) + (baseM * (dims.baseHt / 1000)) + (pantryM * (dims.ceilingMm / 1000));
            const carcassArea = (2 * (dims.upperHt/1000) * (dims.upperDp/1000) + 2 * upperM * (dims.upperDp/1000) + upperM * (dims.upperHt/1000)) + (2 * (dims.baseHt/1000) * (dims.baseDp/1000) + 2 * baseM * (dims.baseDp/1000) + baseM * (dims.baseHt/1000)) + (2 * (dims.ceilingMm/1000) * (dims.pantryDp/1000) + 2 * pantryM * (dims.pantryDp/1000) + pantryM * (dims.ceilingMm/1000));
            const finish = item.finish || 'PVC';
            const shaped = item.shaped === 'yes';
            const doorRate = FINISH_RATES[finish] ? (shaped ? FINISH_RATES[finish].shaped : FINISH_RATES[finish].unshaped) : 100;
            const doorCost = doorArea * doorRate;
            const carcassCost = carcassArea * dims.carcassRate;
            const drawerCost = (item.drawers || 0) * settings.drawerRate;
            const accessoryCost = (item.accessories || 0) * settings.accessoryRate;
            const cabinetryGross = doorCost + carcassCost + drawerCost + accessoryCost;
            const cabinetryUSD = cabinetryGross * (1 - settings.discountRate);
            // Convert cabinetry from USD to CAD (shipping and install are already in CAD)
            const cabinetry = cabinetryUSD * settings.exchangeRate;
            const shipping = totalLF * settings.shippingRate;
            const install = totalLF * settings.installRate;
            const subtotal = cabinetry + shipping + install;
            const finalPrice = subtotal * (1 + settings.markupRate);
            return { totalLF, cabinetry, shipping, install, subtotal, finalPrice, dims };
        }

        function addLineItem() {
            const id = nextId++;
            lineItems.push({ id, name: '', upperLF: 0, baseLF: 0, pantryLF: 0, finish: 'PVC', shaped: 'no', drawers: 0, accessories: 0, ceilingFt: '', carcassSupplier: '', upperHt: 0, baseHt: 0, upperDp: 0, baseDp: 0, pantryDp: 0, showOverride: false, collapsed: false });
            renderLineItems();
            updateTotals();
        }

        function removeLineItem(id, event) {
            event.stopPropagation();
            lineItems = lineItems.filter(item => item.id !== id);
            renderLineItems();
            updateTotals();
        }

        function updateLineItem(id, field, value) {
            const item = lineItems.find(i => i.id === id);
            if (item) {
                const numericFields = ['upperLF', 'baseLF', 'pantryLF', 'drawers', 'accessories', 'upperHt', 'baseHt', 'upperDp', 'baseDp', 'pantryDp'];
                item[field] = numericFields.includes(field) ? (value === '' ? 0 : (parseFloat(value) || 0)) : value;
                updateTotals();
                // Update displayed values without full re-render
                const calc = calculateLineItem(item);
                const priceEl = document.getElementById('price-' + id);
                if (priceEl) priceEl.textContent = formatCurrency(calc.finalPrice);
                const lfEl = document.getElementById('lf-' + id);
                if (lfEl) lfEl.textContent = calc.totalLF + ' LF';
                const cabEl = document.getElementById('cabinetry-' + id);
                if (cabEl) cabEl.textContent = formatCurrency(calc.cabinetry);
                const shipEl = document.getElementById('shipping-' + id);
                if (shipEl) shipEl.textContent = formatCurrency(calc.shipping);
                const instEl = document.getElementById('install-' + id);
                if (instEl) instEl.textContent = formatCurrency(calc.install);
            }
        }

        function renderLineItems() {
            const container = document.getElementById('lineItemsContainer');
            const summary = document.getElementById('quoteSummary');
            if (lineItems.length === 0) {
                container.innerHTML = '<div class="card empty-state"><div class="empty-state-icon">ðŸ“¦</div><h3>No line items yet</h3><p>Add your first room or cabinet section to get started</p><button class="btn btn-primary" onclick="addLineItem()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add First Item</button></div>';
                summary.style.display = 'none';
                return;
            }
            summary.style.display = 'block';
            const settings = getProjectSettings();
            container.innerHTML = lineItems.map((item, index) => {
                const calc = calculateLineItem(item);
                const dims = calc.dims;
                const collapsedClass = item.collapsed ? 'collapsed' : '';
                return '<div class="line-item ' + collapsedClass + '" data-id="' + item.id + '">' +
                    '<div class="line-item-header" onclick="toggleLineItem(' + item.id + ', event)">' +
                        '<div class="line-item-left">' +
                            '<div class="line-item-number">' + (index + 1) + '</div>' +
                            '<input type="text" class="line-item-name-input" placeholder="Room name..." value="' + (item.name || '') + '" onclick="event.stopPropagation()" onchange="updateLineItem(' + item.id + ', \'name\', this.value)">' +
                            '<div class="line-item-summary"><span id="lf-' + item.id + '">' + calc.totalLF + ' LF</span><span>' + item.finish + (item.shaped === 'yes' ? ' (Shaped)' : '') + '</span></div>' +
                        '</div>' +
                        '<div class="line-item-right">' +
                            '<div class="line-item-price" id="price-' + item.id + '">' + formatCurrency(calc.finalPrice) + '</div>' +
                            '<button class="btn btn-danger" onclick="removeLineItem(' + item.id + ', event)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>' +
                            '<svg class="line-item-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>' +
                        '</div>' +
                    '</div>' +
                    '<div class="line-item-body">' +
                        '<div class="line-item-section"><div class="line-item-section-title">Linear Footage</div>' +
                            '<div class="input-group"><label>Upper LF</label><input type="number" value="' + (item.upperLF || '') + '" placeholder="0" onchange="updateLineItem(' + item.id + ', \'upperLF\', this.value)"></div>' +
                            '<div class="input-group"><label>Base LF</label><input type="number" value="' + (item.baseLF || '') + '" placeholder="0" onchange="updateLineItem(' + item.id + ', \'baseLF\', this.value)"></div>' +
                            '<div class="input-group"><label>Pantry LF</label><input type="number" value="' + (item.pantryLF || '') + '" placeholder="0" onchange="updateLineItem(' + item.id + ', \'pantryLF\', this.value)"></div>' +
                        '</div>' +
                        '<div class="line-item-section"><div class="line-item-section-title">Finish & Options</div>' +
                            '<div class="input-group"><label>Finish</label><select onchange="updateLineItem(' + item.id + ', \'finish\', this.value)">' + Object.keys(FINISH_RATES).map(f => '<option value="' + f + '"' + (item.finish === f ? ' selected' : '') + '>' + f + '</option>').join('') + '</select></div>' +
                            '<div class="input-group"><label>Shaped?</label><select onchange="updateLineItem(' + item.id + ', \'shaped\', this.value)"><option value="no"' + (item.shaped === 'no' ? ' selected' : '') + '>No</option><option value="yes"' + (item.shaped === 'yes' ? ' selected' : '') + '>Yes</option></select></div>' +
                            '<div class="input-row"><div class="input-group"><label>Drawers</label><input type="number" value="' + (item.drawers || '') + '" placeholder="0" onchange="updateLineItem(' + item.id + ', \'drawers\', this.value)"></div><div class="input-group"><label>Accessories</label><input type="number" value="' + (item.accessories || '') + '" placeholder="0" onchange="updateLineItem(' + item.id + ', \'accessories\', this.value)"></div></div>' +
                            '<div class="input-group"><label>Carcass Supplier</label><select onchange="updateLineItem(' + item.id + ', \'carcassSupplier\', this.value)"><option value=""' + (!item.carcassSupplier ? ' selected' : '') + '>Default (' + (settings.carcassSupplier === 'holike' ? 'Holike' : 'Allure') + ')</option><option value="holike"' + (item.carcassSupplier === 'holike' ? ' selected' : '') + '>Holike ($65/sqm)</option><option value="allure"' + (item.carcassSupplier === 'allure' ? ' selected' : '') + '>Allure ($200/sqm)</option></select></div>' +
                        '</div>' +
                        '<div class="line-item-section"><div class="line-item-section-title">Dimensions</div>' +
                            '<div class="input-group"><label>Ceiling Height</label><select onchange="updateLineItem(' + item.id + ', \'ceilingFt\', this.value); renderLineItems();"><option value=""' + (!item.ceilingFt ? ' selected' : '') + '>Default (' + settings.defaultCeiling + 'ft)</option><option value="8"' + (item.ceilingFt === '8' ? ' selected' : '') + '>8 ft (96")</option><option value="9"' + (item.ceilingFt === '9' ? ' selected' : '') + '>9 ft (108")</option><option value="10"' + (item.ceilingFt === '10' ? ' selected' : '') + '>10 ft (120")</option><option value="11"' + (item.ceilingFt === '11' ? ' selected' : '') + '>11 ft (132")</option><option value="12"' + (item.ceilingFt === '12' ? ' selected' : '') + '>12 ft (144")</option><option value="13"' + (item.ceilingFt === '13' ? ' selected' : '') + '>13 ft (156")</option></select></div>' +
                            '<div class="dimension-display">Using: Upper ' + formatDimension(dims.upperHt) + ' â€¢ Base ' + formatDimension(dims.baseHt) + '</div>' +
                            '<div class="override-section"><div class="override-toggle ' + (item.showOverride ? 'active' : '') + '" onclick="toggleOverride(' + item.id + ', event)"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' + (item.showOverride ? '<path d="M5 12h14"/>' : '<path d="M12 5v14M5 12h14"/>') + '</svg>' + (item.showOverride ? 'Hide overrides' : 'Override dimensions') + '</div>' +
                            '<div class="override-content ' + (item.showOverride ? 'show' : '') + '">' +
                                '<div class="input-row"><div class="input-group"><label>Upper Ht (mm)</label><input type="number" value="' + (item.upperHt || '') + '" placeholder="' + dims.baseUpperHt + '" onchange="updateLineItem(' + item.id + ', \'upperHt\', this.value); renderLineItems();"></div><div class="input-group"><label>Base Ht (mm)</label><input type="number" value="' + (item.baseHt || '') + '" placeholder="' + settings.defaultBaseHt + '" onchange="updateLineItem(' + item.id + ', \'baseHt\', this.value); renderLineItems();"></div></div>' +
                                '<div class="input-row"><div class="input-group"><label>Upper Dp (mm)</label><input type="number" value="' + (item.upperDp || '') + '" placeholder="' + settings.defaultUpperDp + '" onchange="updateLineItem(' + item.id + ', \'upperDp\', this.value); renderLineItems();"></div><div class="input-group"><label>Base Dp (mm)</label><input type="number" value="' + (item.baseDp || '') + '" placeholder="' + settings.defaultBaseDp + '" onchange="updateLineItem(' + item.id + ', \'baseDp\', this.value); renderLineItems();"></div></div>' +
                                '<div class="input-group"><label>Pantry Dp (mm)</label><input type="number" value="' + (item.pantryDp || '') + '" placeholder="' + settings.defaultPantryDp + '" onchange="updateLineItem(' + item.id + ', \'pantryDp\', this.value); renderLineItems();"></div>' +
                            '</div></div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="line-item-footer">' +
                        '<div class="cost-breakdown"><div class="cost-item"><span class="cost-item-label">Cabinetry:</span><span class="cost-item-value" id="cabinetry-' + item.id + '">' + formatCurrency(calc.cabinetry) + '</span></div><div class="cost-item"><span class="cost-item-label">Shipping:</span><span class="cost-item-value" id="shipping-' + item.id + '">' + formatCurrency(calc.shipping) + '</span></div><div class="cost-item"><span class="cost-item-label">Install:</span><span class="cost-item-value" id="install-' + item.id + '">' + formatCurrency(calc.install) + '</span></div></div>' +
                        '<div style="font-size: 0.8125rem; color: var(--text-muted);">' + calc.totalLF + ' LF â€¢ ' + (dims.carcassSupplier === 'holike' ? 'Holike' : 'Allure') + '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function updateTotals() {
            let totalLF = 0, totalCabinetry = 0, totalShipping = 0, totalInstall = 0, totalSubtotal = 0, grandTotal = 0;
            lineItems.forEach(item => {
                const calc = calculateLineItem(item);
                totalLF += calc.totalLF;
                totalCabinetry += calc.cabinetry;
                totalShipping += calc.shipping;
                totalInstall += calc.install;
                totalSubtotal += calc.subtotal;
                grandTotal += calc.finalPrice;
            });
            document.getElementById('totalLF').textContent = totalLF + ' LF Total';
            document.getElementById('totalCabinetry').textContent = formatCurrency(totalCabinetry);
            document.getElementById('totalShipping').textContent = formatCurrency(totalShipping);
            document.getElementById('totalInstall').textContent = formatCurrency(totalInstall);
            document.getElementById('totalSubtotal').textContent = formatCurrency(totalSubtotal);
            document.getElementById('grandTotal').textContent = formatCurrency(grandTotal);
            document.getElementById('headerTotal').textContent = formatCurrency(grandTotal);
        }

        function recalculateAll() { renderLineItems(); updateTotals(); }

        function onProjectTypeChange() {
            const projectType = document.getElementById('projectType').value;
            document.getElementById('installRate').value = projectType === 'full' ? 100 : 120;
            recalculateAll();
        }

        function onCeilingChange() {
            const ceiling = document.getElementById('defaultCeiling').value;
            const upperHt = CEILING_TO_UPPER_HT[ceiling] || 760;
            document.getElementById('defaultUpperHt').value = upperHt;
            document.getElementById('upperHtDisplay').textContent = formatDimension(upperHt);
            recalculateAll();
        }

        renderLineItems();
        onCeilingChange();
    </script>
</body>
</html>
